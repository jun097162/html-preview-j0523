<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>契約更新ダッシュボード（改修版 V7）</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #f4f7f9;
            color: #333;
            font-size: 14px;
        }

        .dashboard-container {
            padding: 20px;
            max-width: 100%;
        }

        .dashboard-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .dashboard-header h1 {
            font-size: 24px;
            margin-top: 0;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .office-info {
            font-size: 16px;
            color: #555;
            margin-bottom: 15px;
        }
        .office-info strong {
            font-weight: 600;
            color: #333;
        }

        .actions-filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .actions-filter-bar .filter-group,
        .actions-filter-bar .action-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .actions-filter-bar input[type="text"],
        .actions-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .actions-filter-bar input[type="text"]::placeholder {
            color: #aaa;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .btn-primary { background-color: #3498db; color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #7f8c8d; color: white; }
        .btn-secondary:hover { background-color: #6c7a89; }
        .btn-success { background-color: #2ecc71; color: white; }
        .btn-success:hover { background-color: #27ae60; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-info { background-color: #5bc0de; color: white; } 
        .btn-info:hover { background-color: #31b0d5; }


        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            max-height: 70vh; 
            overflow-y: auto; 
        }

        .dashboard-table {
            width: 100%;
            min-width: 5800px; 
            border-collapse: collapse;
            white-space: nowrap;
        }

        .dashboard-table th,
        .dashboard-table td {
            padding: 7px 9px; 
            text-align: left;
            border: 1px solid #e0e0e0; 
            vertical-align: middle; 
        }
        .dashboard-table th.sub-header { 
            padding-top: 2px;  
            padding-bottom: 2px; 
            font-size: 0.8em; 
            text-align: center;
            border-top: 1px solid #d0d0d0; 
        }
        .dashboard-table th[colspan="2"] {
            border-bottom: none; 
            text-align: center;
        }
        .dashboard-table th[rowspan="2"] {
            vertical-align: middle; 
        }


        /* --- Sticky Header and Column Styling --- */
        .dashboard-table thead th {
            position: sticky;
            background-color: #f8f9fa; 
            font-weight: 600;
            color: #555;
        }
        
        .dashboard-table thead tr:first-child th {
            top: 0;
            z-index: 5; 
        }
        .dashboard-table thead tr:first-child th:nth-child(-n+5) { 
            background-color: #eff1f3; 
            z-index: 7; 
        }

        .dashboard-table thead tr:nth-child(2) th {
            position: sticky; 
            background-color: #f8f9fa;
            z-index: 4; 
        }
        .dashboard-table thead tr:nth-child(2) th:nth-child(-n+5) { 
            background-color: #eff1f3;
            z-index: 6; 
        }
        
        .dashboard-table tbody td:nth-child(-n+5) {
            position: sticky;
            background-color: #fff; 
            z-index: 2; 
        }
        
        .dashboard-table th:nth-child(1), .dashboard-table td:nth-child(1) { left: 0; min-width: 50px; }
        .dashboard-table th:nth-child(2), .dashboard-table td:nth-child(2) { left: 50px; min-width: 120px; }
        .dashboard-table th:nth-child(3), .dashboard-table td:nth-child(3) { left: 170px; min-width: 200px; }
        .dashboard-table th:nth-child(4), .dashboard-table td:nth-child(4) { left: 370px; min-width: 100px; }
        .dashboard-table th:nth-child(5), .dashboard-table td:nth-child(5) { left: 470px; min-width: 150px; }
        /* --- End of Sticky Styling --- */

        
        .current-value-cell,
        .calculated-readonly-cell {
            background-color: #f9f9f9;
            color: #555;
        }
        .highlight-average-ref {
            background-color: #fff0f5 !important; 
            font-weight: bold;
        }


        .dashboard-table td[contenteditable="true"] {
            background-color: #f0f8ff;
            cursor: text;
        }
        .dashboard-table td[contenteditable="false"].editable-was-true {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .dashboard-table td.highlight-changed {
            background-color: #fffacd !important;
            font-weight: bold;
        }
        .highlight-labor-cost { 
            font-weight: bold;
        }
        .dashboard-table td.highlight-labor-cost {
             background-color: #e6f7ff !important;
        }

        .labor-cost-plus { color: green; }
        .labor-cost-minus { color: red; }


        .dashboard-table tbody tr:hover td {
            background-color: #f1f3f5 !important;
        }
        .dashboard-table tbody tr:hover td:nth-child(-n+5) { 
            background-color: #e8ebee !important; 
        }

        .row-highlight-agreed td { 
             background-color: #d4edda !important;
        }
        .row-locked.row-highlight-agreed td.editable-was-true {
            background-color: #cce5d0 !important; 
        }
        .row-highlight-agreed td:nth-child(-n+5) { 
            background-color: #cce5d0 !important;
        }


        .status-label {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            color: white;
            min-width: 80px;
            text-align: center;
        }

        .status-managing { background-color: #3498db; } 
        .status-pending { background-color: #1abc9c; } 
        .status-member-support { background-color: #f1c40f; color:#333; } 
        .status-rejected { background-color: #e74c3c; } 
        .status-completed { background-color: #2ecc71; } 
        .status-default { background-color: #95a5a6; } 
        .status-returned { 
            background-color: #e67e22;
            cursor: pointer;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        .status-returned:hover { background-color: #d35400; }
        .status-agreed { background-color: #28a745; } 
        .status-notified { background-color: #5bc0de; } 

        /* --- Column Widths & Alignment for Specific Data --- */
        .dashboard-table td[data-column-name="hourly_wage_current"],
        .dashboard-table td[data-column-name="hourly_wage_new"] {
            min-width: 80px;
            text-align: right;
        }
        .dashboard-table td[data-column-name="manager_allowance_current"],
        .dashboard-table td[data-column-name="manager_allowance_new"] {
            min-width: 90px;
            text-align: right;
        }
        .dashboard-table td[data-column-name="annual_bonus_months_current"],
        .dashboard-table td[data-column-name="annual_bonus_months_new"] {
            min-width: 70px; 
            text-align: right;
        }
        .dashboard-table td[data-column-name="contract_hours_day_current"],
        .dashboard-table td[data-column-name="contract_hours_day_new"] {
            min-width: 70px; 
            text-align: right;
        }
        .dashboard-table td[data-column-name="contract_days_month_current"],
        .dashboard-table td[data-column-name="contract_days_month_new"] {
            min-width: 70px; 
            text-align: right;
        }
        .dashboard-table td[data-column-name^="additional_wage2_"], 
        .dashboard-table td[data-column-name^="additional_wage3_"],
        .dashboard-table td[data-column-name^="additional_wage4_"] {
            min-width: 80px;
            text-align: right;
        }
        .dashboard-table td[data-column-name^="other_allowance1_"],
        .dashboard-table td[data-column-name^="other_allowance2_"] {
            min-width: 90px;
            text-align: right;
        }
        .dashboard-table td[data-column-name="expected_labor_cost"],
        .dashboard-table td[data-column-name="updated_labor_cost"],
        .dashboard-table td[data-column-name="labor_cost_difference"] {
            min-width: 100px; 
            text-align: right;
        }
        /* --- End of Column Widths & Alignment --- */


        .dashboard-table input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .delay-flag-true { color: #e74c3c; font-weight: bold; }
        .delay-flag-false { color: #333; }

        .confirmation-area { margin-top: 20px; padding: 15px; background-color: #e9f5ff; border: 1px solid #b3d7ff; border-radius: 6px; text-align: right; }
        .confirmation-area p { margin: 0 0 10px 0; font-size: 15px; color: #2c3e50; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 6px; position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>契約更新ダッシュボード（改修版 V7）</h1>
            <div class="office-info">
                <p>
                    <strong>事業所:</strong> 首都圏BI第二事業本部　東京BI第4事業部<br>
                    <strong>事業部長:</strong> 木村浩一郎
                </p>
            </div>
        </header>

        <div class="actions-filter-bar">
            <div class="filter-group">
                <input type="text" id="employeeFilter" placeholder="従業員で絞り込む">
                <button class="btn btn-info" id="notifySelectedBtn">チェックした方へ通知を送信</button>
                <button class="btn btn-danger" id="deleteSelectedBtn">チェックした依頼を削除する</button>
                <button class="btn btn-secondary" id="resetToDefaultBtn">選択をデフォルト値に戻す</button>
            </div>
            <div class="filter-group">
                <select id="statusFilter">
                    <option value="incomplete">手続の状況 未完了</option>
                    <option value="all">手続の状況 全て</option>
                    <option value="complete">手続の状況 完了</option>
                </select>
                <select id="dateFilterType">
                    <option value="request_date">依頼日</option>
                    <option value="due_date">提出期限</option>
                </select>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="dashboard-table" id="dashboardTable">
                <thead>
                    <tr>
                        <th rowspan="2"><input type="checkbox" id="selectAllCheckbox" title="すべて選択"></th>
                        <th rowspan="2">ステータス</th>
                        <th rowspan="2">事業所名</th>
                        <th rowspan="2">従業員番号</th>
                        <th rowspan="2">従業員名</th>
                        <th rowspan="2">送付日</th>
                        <th rowspan="2">開封日</th>
                        <th rowspan="2">同意</th>
                        <th rowspan="2">同意日</th>
                        <th rowspan="2">雇用形態</th>
                        <th rowspan="2">契約開始日</th>
                        <th colspan="2">契約終了日</th>
                        <th colspan="2">時給</th>
                        <th colspan="2">責任者手当</th>
                        <th colspan="2">賞与年間(月数)</th>
                        <th colspan="2">契約時間数/日</th>
                        <th colspan="2">契約日数/月</th>
                        <th rowspan="2" class="highlight-average-ref">3か月平均<br>勤務時間/日</th>
                        <th rowspan="2" class="highlight-average-ref">3か月平均<br>勤務日数</th>
                        <th colspan="2">シフト1</th>
                        <th colspan="2">シフト1休憩(分)</th>
                        <th colspan="2">シフト2</th>
                        <th colspan="2">シフト2休憩(分)</th>
                        <th colspan="2">第2加算時給</th>
                        <th colspan="2">第3加算時給</th>
                        <th colspan="2">第4加算時給</th>
                        <th colspan="2">その他手当1</th>
                        <th colspan="2">その他手当2</th>
                        <th rowspan="2" class="highlight-labor-cost">想定労務費</th>
                        <th rowspan="2" class="highlight-labor-cost">変更後労務費</th>
                        <th rowspan="2" class="highlight-labor-cost">変更後労務費乖離</th>
                        <th rowspan="2">社会保険加入</th>
                        <th rowspan="2">雇用保険加入</th>
                        <th rowspan="2">リマインド日</th>
                        <th rowspan="2">提出期限</th>
                        <th rowspan="2">遅延フラグ</th>
                        <th rowspan="2">備考</th>
                    </tr>
                    <tr>
                        <!-- 「現」「新」ヘッダー行 -->
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                        <th class="sub-header">現</th><th class="sub-header">新</th>
                    </tr>
                </thead>
                <tbody id="dashboardTableBody">
                    <!-- JavaScript will insert sample records here -->
                </tbody>
            </table>
        </div>

        <div class="confirmation-area">
            <p><span id="changedRecordCount">0</span>件のレコードに変更があります。</p>
            <button class="btn btn-success" id="confirmAndUpdateBtn">変更を確定し人事マスタを更新</button>
        </div>
    </div>

    <!-- Modal for rejection reason -->
    <div id="rejectionModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>差し戻し理由</h2>
            <p id="rejectionReasonText"></p>
        </div>
    </div>

    <script>
        // --- Global constants and helper functions (same as V6) ---
        const officeNamesFromCSV = [
            "上智大学１１号館ラウンジ", "中央合同庁舎７号館", "（株）リクルート空箱", "（株）リクルート（３０Ｆ）ほこらん",
            "（株）リクルートグラントウキヨウサウスタワー３６Ｆ侍", "日本体育大学世田谷キヤンパスカフエテリア",
            "リクルートharema事業所", "日本体育大学　和泉寮", "日本体育大学　深沢寮", "株式会社ADEKA_本社ビル",
            "野村総研新本社カフェ", "野村総研　みなとみらい", "東京ドームカフェテリア１１",
            "三菱自動車工業株式会社本社カフェテリア", "熱海後楽園ホテル", "山九株式会社", "東京ドームホテル従業員食堂",
            "朝日新聞本社", "ソニーイメージングプロダクツ&ソリューションズ株式会社　本社",
            "パナソニック株式会社アプライアンス社　", "証券保管振替機構", "（株）千代田グラビヤ", "（株）ＢＭＬ本社",
             "（学）清泉女子大学", "ミズノ（株）"
        ];
        const lastNames = ["佐藤", "鈴木", "高橋", "田中", "渡辺", "伊藤", "山本", "中村", "小林", "加藤", "吉田", "山田", "佐々木", "山口", "松本", "井上", "木村", "林", "斎藤", "清水"];
        const firstNames = ["一郎", "花子", "太郎", "純子", "健太", "美咲", "大輔", "さくら", "学", "京子", "直樹", "陽子", "浩", "恵子", "明", "愛", "徹", "久美子", "進", "良子"];
        const dummyStatuses = ["同意済み", "修正依頼中", "完了済み", "差し戻し", "通知済み", "未着手"];

        function getRandomOfficeName() { return officeNamesFromCSV[Math.floor(Math.random() * officeNamesFromCSV.length)]; }
        function getRandomEmployeeName() { return `${lastNames[Math.floor(Math.random() * lastNames.length)]} ${firstNames[Math.floor(Math.random() * firstNames.length)]}`; }
        function getRandomEmployeeId(index) { return (300000 + index + Math.floor(Math.random() * 1000)).toString().padStart(6, '0'); }
        function getRandomDate(startYear = 2025, endYear = 2026) {
            const year = Math.floor(Math.random() * (endYear - startYear + 1)) + startYear;
            const month = Math.floor(Math.random() * 12) + 1;
            const day = Math.floor(Math.random() * 28) + 1; 
            return `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
        }
        function getRandomSupplerHourlyWage() { return (Math.floor(Math.random() * ((2500 - 1200) / 10 + 1)) * 10) + 1200; }
        function getRandomAllowance(maxAmount = 5000, step = 1000) { 
            if (Math.random() < 0.3) return 0; 
            return (Math.floor(Math.random() * (maxAmount / step)) + 1) * step;
        }
        function getRandomBonusMonths() { 
            const months = [0, 0.5, 1.0, 1.5, 2.0];
            if (Math.random() < 0.5) return "0.0ヶ月"; 
            return months[Math.floor(Math.random() * months.length)].toFixed(1) + "ヶ月";
        }
        function parseNumericValue(value) {
            if (value === null || typeof value === 'undefined' || String(value).trim() === '' || String(value).trim() === '-') {
                return 0;
            }
            const numStr = String(value).replace(/,/g, '').replace(/ヶ月/g, '');
            const num = parseFloat(numStr);
            return isNaN(num) ? 0 : num;
        }
        const formatCurrencyOrHyphen = (val) => {
            const numVal = parseNumericValue(val);
            if (String(val).trim() === '-' && numVal === 0) return '-'; 
            return numVal.toLocaleString('ja-JP');
        };
         const formatMonthsOrHyphen = (val) => { 
            const numVal = parseNumericValue(val);
            if (String(val).trim() === '-' && numVal === 0 && !String(val).includes("ヶ月")) return '-';
            if (String(val).trim().endsWith("ヶ月")) return val; 
            return numVal.toFixed(1) + "ヶ月";
        };
        function calculateExpectedLaborCost(row) {
            const hourlyWage = parseNumericValue(row.querySelector('[data-column-name="hourly_wage_current"]').textContent);
            const contractHoursDay = parseNumericValue(row.querySelector('[data-column-name="contract_hours_day_current"]').textContent);
            const contractDaysMonth = parseNumericValue(row.querySelector('[data-column-name="contract_days_month_current"]').textContent);
            const managerAllowance = parseNumericValue(row.querySelector('[data-column-name="manager_allowance_current"]').textContent);
            const otherAllowance1 = parseNumericValue(row.querySelector('[data-column-name="other_allowance1_current"]').textContent);
            const otherAllowance2 = parseNumericValue(row.querySelector('[data-column-name="other_allowance2_current"]').textContent);
            return Math.round((hourlyWage * contractHoursDay * contractDaysMonth) + managerAllowance + otherAllowance1 + otherAllowance2);
        }
        function calculateUpdatedLaborCost(row) {
            const hourlyWage = parseNumericValue(row.querySelector('[data-column-name="hourly_wage_new"]').textContent);
            const contractHoursDay = parseNumericValue(row.querySelector('[data-column-name="contract_hours_day_new"]').textContent);
            const contractDaysMonth = parseNumericValue(row.querySelector('[data-column-name="contract_days_month_new"]').textContent);
            const managerAllowance = parseNumericValue(row.querySelector('[data-column-name="manager_allowance_new"]').textContent);
            const otherAllowance1 = parseNumericValue(row.querySelector('[data-column-name="other_allowance1_new"]').textContent);
            const otherAllowance2 = parseNumericValue(row.querySelector('[data-column-name="other_allowance2_new"]').textContent);
            return Math.round((hourlyWage * contractHoursDay * contractDaysMonth) + managerAllowance + otherAllowance1 + otherAllowance2);
        }
        function updateLaborCostColumns(row) {
            const expectedCostCell = row.querySelector('[data-column-name="expected_labor_cost"]');
            const updatedCostCell = row.querySelector('[data-column-name="updated_labor_cost"]');
            const differenceCell = row.querySelector('[data-column-name="labor_cost_difference"]');

            if (!expectedCostCell || !updatedCostCell || !differenceCell) return;

            const expectedCost = calculateExpectedLaborCost(row);
            const updatedCost = calculateUpdatedLaborCost(row);
            
            expectedCostCell.textContent = expectedCost.toLocaleString('ja-JP');
            updatedCostCell.textContent = updatedCost.toLocaleString('ja-JP');

            let difference = updatedCost - expectedCost;
            if (Math.abs(difference) < 0.001) { difference = 0; }
            
            differenceCell.textContent = difference.toLocaleString('ja-JP');
            differenceCell.classList.remove('labor-cost-plus', 'labor-cost-minus');
            if (difference > 0) differenceCell.classList.add('labor-cost-plus');
            else if (difference < 0) differenceCell.classList.add('labor-cost-minus');
        }
        function setStatusCell(cell, statusText, remarksText = '') {
            cell.innerHTML = '';
            let element;
            let statusClass = '';

            switch (statusText) {
                case "同意済み": statusClass = 'status-agreed'; break;
                case "修正依頼中": statusClass = 'status-rejected'; break;
                case "完了済み": statusClass = 'status-completed'; break;
                case "差し戻し": statusClass = 'status-returned'; break;
                case "通知済み": statusClass = 'status-notified'; break; 
                case "未着手": statusClass = 'status-default'; break;
                case "管理中": statusClass = 'status-managing'; break;
                case "確認中": statusClass = 'status-pending'; break;
                case "メンバー対応中": statusClass = 'status-member-support'; break;
                default: statusClass = 'status-default'; break;
            }

            if (statusText === "差し戻し") {
                element = document.createElement('button');
                element.classList.add('status-label', statusClass);
                element.textContent = statusText;
                element.addEventListener('click', function() {
                    const modal = document.getElementById('rejectionModal');
                    const rejectionReasonText = document.getElementById('rejectionReasonText');
                    if (modal && rejectionReasonText) {
                         rejectionReasonText.textContent = remarksText || "差し戻し理由の記載がありません。";
                         modal.style.display = 'block';
                    }
                });
            } else {
                element = document.createElement('span');
                element.classList.add('status-label', statusClass);
                element.textContent = statusText;
            }
            cell.appendChild(element);
        }
        
        function adjustStickyHeaderTops() {
            const headerRows = document.querySelectorAll('.dashboard-table thead tr');
            if (headerRows.length < 2) return;

            const firstActualRowHeight = headerRows[0].getBoundingClientRect().height;
            
            const secondRowThs = headerRows[1].querySelectorAll('th');
            secondRowThs.forEach(th => {
                th.style.top = firstActualRowHeight + 'px';
            });
        }

        // --- Main DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('dashboardTableBody');
            const modal = document.getElementById('rejectionModal');
            const closeButton = modal.querySelector('.close-button');
            const notifySelectedBtn = document.getElementById('notifySelectedBtn');


            if (tableBody.children.length === 0) {
                const agreementTypes = ["済", "未"];
                const booleanTypes = ["加入", "未加入", "-"];
                const delayTypes = ["なし", "あり"];

                for (let i = 1; i <= 50; i++) {
                    const row = document.createElement('tr');
                    row.dataset.recordId = i.toString();
                    
                    const currentStatus = dummyStatuses[(i - 1) % dummyStatuses.length];
                    const agreement = agreementTypes[Math.floor(Math.random() * agreementTypes.length)];

                    const sampleData = {
                        status: currentStatus,
                        send_date: getRandomDate(),
                        open_date: Math.random() > 0.3 ? getRandomDate() : '-',
                        agreement: agreement,
                        agreement_date: (currentStatus === "同意済み" || agreement === '済') ? getRandomDate() : '-',
                        office_name: getRandomOfficeName(),
                        employee_id: getRandomEmployeeId(i),
                        employee_name: getRandomEmployeeName(),
                        employment_type: "サプラー",
                        contract_start_date: getRandomDate(),
                        contract_end_date: Math.random() > 0.5 ? getRandomDate(2026, 2027) : '-',
                        hourly_wage: getRandomSupplerHourlyWage(),
                        manager_allowance: getRandomAllowance(50000, 10000),
                        annual_bonus_months: getRandomBonusMonths(),
                        contract_hours_day: (Math.random() * 4 + 4).toFixed(1),
                        contract_days_month: Math.floor(Math.random() * 10) + 15,
                        avg_work_hours_day: (Math.random() * 2 + 6).toFixed(1), 
                        avg_work_days: (Math.random() * 5 + 15).toFixed(1),   
                        shift1: "9:00-18:00",
                        shift1_break: "60",
                        shift2: "-",
                        shift2_break: "-",
                        additional_wage2: getRandomAllowance(3000, 500), 
                        additional_wage3: getRandomAllowance(3000, 500), 
                        additional_wage4: getRandomAllowance(3000, 500), 
                        other_allowance1: getRandomAllowance(10000, 1000),
                        other_allowance2: getRandomAllowance(5000, 1000),
                        social_insurance: booleanTypes[Math.floor(Math.random()*booleanTypes.length)],
                        employment_insurance: booleanTypes[Math.floor(Math.random()*booleanTypes.length)],
                        reminder_date: Math.random() > 0.2 ? getRandomDate() : '-',
                        due_date: getRandomDate(),
                        delay_flag_text: delayTypes[Math.floor(Math.random()*delayTypes.length)],
                        remarks: `備考サンプル ${i}`
                    };
                    
                    row.innerHTML = `
                        <td><input type="checkbox" class="row-checkbox"></td>
                        <td data-column-name="status" data-initial-value="${sampleData.status}"></td>
                        <td data-column-name="office_name" data-initial-value="${sampleData.office_name}">${sampleData.office_name}</td>
                        <td data-column-name="employee_id" data-initial-value="${sampleData.employee_id}">${sampleData.employee_id}</td>
                        <td data-column-name="employee_name" data-initial-value="${sampleData.employee_name}">${sampleData.employee_name}</td>
                        <td data-column-name="send_date" data-initial-value="${sampleData.send_date}">${sampleData.send_date}</td>
                        <td data-column-name="open_date" data-initial-value="${sampleData.open_date}">${sampleData.open_date}</td>
                        <td data-column-name="agreement" data-initial-value="${sampleData.agreement}">${sampleData.agreement}</td>
                        <td data-column-name="agreement_date" data-initial-value="${sampleData.agreement_date}">${sampleData.agreement_date}</td>
                        <td data-column-name="employment_type" data-initial-value="${sampleData.employment_type}">${sampleData.employment_type}</td>
                        <td data-column-name="contract_start_date" data-initial-value="${sampleData.contract_start_date}">${sampleData.contract_start_date}</td>
                        
                        <td class="current-value-cell" data-column-name="contract_end_date_current" data-initial-value="${sampleData.contract_end_date}">${sampleData.contract_end_date}</td>
                        <td data-column-name="contract_end_date_new" data-initial-value="${sampleData.contract_end_date}" contenteditable="true">${sampleData.contract_end_date}</td>
                        <td class="current-value-cell" data-column-name="hourly_wage_current" data-initial-value="${sampleData.hourly_wage}">${formatCurrencyOrHyphen(sampleData.hourly_wage)}</td>
                        <td data-column-name="hourly_wage_new" data-initial-value="${sampleData.hourly_wage}" contenteditable="true">${formatCurrencyOrHyphen(sampleData.hourly_wage)}</td>
                        <td class="current-value-cell" data-column-name="manager_allowance_current" data-initial-value="${sampleData.manager_allowance}">${formatCurrencyOrHyphen(sampleData.manager_allowance)}</td>
                        <td data-column-name="manager_allowance_new" data-initial-value="${sampleData.manager_allowance}" contenteditable="true">${formatCurrencyOrHyphen(sampleData.manager_allowance)}</td>
                        
                        <td class="current-value-cell" data-column-name="annual_bonus_months_current" data-initial-value="${sampleData.annual_bonus_months}">${formatMonthsOrHyphen(sampleData.annual_bonus_months)}</td>
                        <td data-column-name="annual_bonus_months_new" data-initial-value="${sampleData.annual_bonus_months}" contenteditable="true">${formatMonthsOrHyphen(sampleData.annual_bonus_months)}</td>
                        
                        <td class="current-value-cell" data-column-name="contract_hours_day_current" data-initial-value="${sampleData.contract_hours_day}">${sampleData.contract_hours_day}</td>
                        <td data-column-name="contract_hours_day_new" data-initial-value="${sampleData.contract_hours_day}" contenteditable="true">${sampleData.contract_hours_day}</td>
                        <td class="current-value-cell" data-column-name="contract_days_month_current" data-initial-value="${sampleData.contract_days_month}">${sampleData.contract_days_month}</td>
                        <td data-column-name="contract_days_month_new" data-initial-value="${sampleData.contract_days_month}" contenteditable="true">${sampleData.contract_days_month}</td>
                        
                        <td class="current-value-cell highlight-average-ref" data-column-name="avg_work_hours_day_ref">${sampleData.avg_work_hours_day}</td>
                        <td class="current-value-cell highlight-average-ref" data-column-name="avg_work_days_ref">${sampleData.avg_work_days}</td>
                        
                        <td class="current-value-cell" data-column-name="shift1_current" data-initial-value="${sampleData.shift1}">${sampleData.shift1}</td>
                        <td data-column-name="shift1_new" data-initial-value="${sampleData.shift1}" contenteditable="true">${sampleData.shift1}</td>
                        <td class="current-value-cell" data-column-name="shift1_break_current" data-initial-value="${sampleData.shift1_break}">${sampleData.shift1_break}</td>
                        <td data-column-name="shift1_break_new" data-initial-value="${sampleData.shift1_break}" contenteditable="true">${sampleData.shift1_break}</td>
                        <td class="current-value-cell" data-column-name="shift2_current" data-initial-value="${sampleData.shift2}">${sampleData.shift2}</td>
                        <td data-column-name="shift2_new" data-initial-value="${sampleData.shift2}" contenteditable="true">${sampleData.shift2}</td>
                        <td class="current-value-cell" data-column-name="shift2_break_current" data-initial-value="${sampleData.shift2_break}">${sampleData.shift2_break}</td>
                        <td data-column-name="shift2_break_new" data-initial-value="${sampleData.shift2_break}" contenteditable="true">${sampleData.shift2_break}</td>
                        
                        <td class="current-value-cell" data-column-name="additional_wage2_current" data-initial-value="${sampleData.additional_wage2}">${formatCurrencyOrHyphen(sampleData.additional_wage2)}</td>
                        <td data-column-name="additional_wage2_new" data-initial-value="${sampleData.additional_wage2}" contenteditable="true">${formatCurrencyOrHyphen(sampleData.additional_wage2)}</td>
                        <td class="current-value-cell" data-column-name="additional_wage3_current" data-initial-value="${sampleData.additional_wage3}">${formatCurrencyOrHyphen(sampleData.additional_wage3)}</td>
                        <td data-column-name="additional_wage3_new" data-initial-value="${sampleData.additional_wage3}" contenteditable="true">${formatCurrencyOrHyphen(sampleData.additional_wage3)}</td>
                        <td class="current-value-cell" data-column-name="additional_wage4_current" data-initial-value="${sampleData.additional_wage4}">${formatCurrencyOrHyphen(sampleData.additional_wage4)}</td>
                        <td data-column-name="additional_wage4_new" data-initial-value="${sampleData.additional_wage4}" contenteditable="true">${formatCurrencyOrHyphen(sampleData.additional_wage4)}</td>

                        <td class="current-value-cell" data-column-name="other_allowance1_current" data-initial-value="${sampleData.other_allowance1}">${formatCurrencyOrHyphen(sampleData.other_allowance1)}</td>
                        <td data-column-name="other_allowance1_new" data-initial-value="${sampleData.other_allowance1}" contenteditable="true">${formatCurrencyOrHyphen(sampleData.other_allowance1)}</td>
                        <td class="current-value-cell" data-column-name="other_allowance2_current" data-initial-value="${sampleData.other_allowance2}">${formatCurrencyOrHyphen(sampleData.other_allowance2)}</td>
                        <td data-column-name="other_allowance2_new" data-initial-value="${sampleData.other_allowance2}" contenteditable="true">${formatCurrencyOrHyphen(sampleData.other_allowance2)}</td>
                        
                        <td data-column-name="expected_labor_cost" class="calculated-readonly-cell highlight-labor-cost"></td>
                        <td data-column-name="updated_labor_cost" class="calculated-readonly-cell highlight-labor-cost"></td>
                        <td data-column-name="labor_cost_difference" class="calculated-readonly-cell highlight-labor-cost"></td>
                        
                        <td data-column-name="social_insurance" data-initial-value="${sampleData.social_insurance}">${sampleData.social_insurance}</td>
                        <td data-column-name="employment_insurance" data-initial-value="${sampleData.employment_insurance}">${sampleData.employment_insurance}</td>
                        <td data-column-name="reminder_date" data-initial-value="${sampleData.reminder_date}">${sampleData.reminder_date}</td>
                        <td data-column-name="due_date" data-initial-value="${sampleData.due_date}">${sampleData.due_date}</td>
                        <td data-column-name="delay_flag" data-initial-value="${sampleData.delay_flag_text}"><span class="delay-flag-${sampleData.delay_flag_text === 'あり' ? 'true' : 'false'}">${sampleData.delay_flag_text}</span></td>
                        <td data-column-name="remarks" data-initial-value="${sampleData.remarks}" contenteditable="true">${sampleData.remarks}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
            adjustStickyHeaderTops(); 

            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const editableCells = row.querySelectorAll('td[contenteditable="true"]');
                editableCells.forEach(cell => {
                    const initialVal = cell.dataset.initialValue;
                    const columnName = cell.dataset.columnName;
                    if (columnName && (columnName.includes('hourly_wage_new') || columnName.includes('allowance_new') || (columnName.startsWith('additional_wage') && columnName.endsWith('_new')))) {
                         cell.textContent = formatCurrencyOrHyphen(initialVal);
                    } else if (columnName === 'annual_bonus_months_new') {
                         cell.textContent = formatMonthsOrHyphen(initialVal);
                    }
                    else if (columnName && (columnName.includes('contract_hours_day_new') || columnName.includes('contract_days_month_new'))) {
                         cell.textContent = (initialVal === '-' || initialVal === '0' && parseNumericValue(initialVal) === 0) ? initialVal : parseNumericValue(initialVal).toString();
                    }
                    else {
                         cell.textContent = initialVal;
                    }
                });
                
                updateLaborCostColumns(row); 

                const statusCell = row.querySelector('[data-column-name="status"]');
                const currentStatus = statusCell.dataset.initialValue.trim();
                const remarksText = row.querySelector('[data-column-name="remarks"]').textContent.trim(); 

                setStatusCell(statusCell, currentStatus, remarksText);

                row.classList.remove('row-highlight-agreed', 'row-locked');
                const allEditableCandidateCells = row.querySelectorAll('td[data-column-name$="_new"], td[data-column-name="remarks"]');

                if (currentStatus === '同意済み') {
                    row.classList.add('row-highlight-agreed', 'row-locked');
                    allEditableCandidateCells.forEach(cell => {
                        cell.setAttribute('contenteditable', 'false');
                        cell.classList.add('editable-was-true');
                    });
                } else {
                    allEditableCandidateCells.forEach(cell => {
                        if (cell.dataset.columnName === "remarks" || (cell.dataset.columnName && cell.dataset.columnName.endsWith("_new"))) {
                            cell.setAttribute('contenteditable', 'true');
                            cell.classList.remove('editable-was-true');
                            cell.style.backgroundColor = '#f0f8ff'; 
                        }
                    });
                }
            });

            tableBody.addEventListener('blur', function(event) {
                const cell = event.target;
                if (cell.tagName === 'TD' && cell.getAttribute('contenteditable') === 'true') {
                    const initialValue = cell.dataset.initialValue || '';
                    let currentValue = cell.textContent.trim();
                    const columnName = cell.dataset.columnName;

                    if (columnName && (columnName.includes('hourly_wage_new') || columnName.includes('allowance_new') || (columnName.startsWith('additional_wage') && columnName.endsWith('_new')) )) {
                        const numericVal = parseNumericValue(currentValue);
                        currentValue = formatCurrencyOrHyphen(numericVal);
                        cell.textContent = currentValue; 
                    } else if (columnName === 'annual_bonus_months_new') {
                        const numericVal = parseNumericValue(currentValue);
                        currentValue = formatMonthsOrHyphen(numericVal);
                        cell.textContent = currentValue;
                    }
                    else if (columnName && (columnName.includes('contract_hours_day_new') || columnName.includes('contract_days_month_new'))) {
                        const numericVal = parseNumericValue(currentValue);
                        currentValue = (numericVal === 0 && (initialValue === '-' || String(initialValue).trim() === '0')) ? (String(currentValue).trim() === '' ? initialValue : currentValue) : numericVal.toString();
                        if(String(cell.textContent).trim() === '' && initialValue === '-') currentValue = '-'; 
                        else if(String(cell.textContent).trim() === '') currentValue = '0'; 
                        cell.textContent = currentValue;
                    }


                    if (initialValue !== currentValue) {
                        cell.classList.add('highlight-changed');
                    } else {
                        cell.classList.remove('highlight-changed');
                    }
                    updateChangedRecordCount();

                    const costRelatedNewColumns = [
                        'hourly_wage_new', 'contract_hours_day_new', 'contract_days_month_new', 
                        'manager_allowance_new', 'other_allowance1_new', 'other_allowance2_new'
                    ];
                    if (costRelatedNewColumns.includes(cell.dataset.columnName)) {
                        updateLaborCostColumns(cell.closest('tr'));
                    }
                }
            }, true);

            if (closeButton) {
                closeButton.onclick = function() { if(modal) modal.style.display = "none"; }
            }
            if (modal) {
                window.onclick = function(event) { if (event.target == modal) modal.style.display = "none"; }
            }
            window.addEventListener('resize', adjustStickyHeaderTops); 

            function updateChangedRecordCount() {
                if (!tableBody) return;
                const changedCells = tableBody.querySelectorAll('td.highlight-changed');
                const changedRecordIds = new Set();
                changedCells.forEach(cell => {
                    const row = cell.closest('tr');
                    if (row && row.dataset.recordId) changedRecordIds.add(row.dataset.recordId);
                });
                const countElement = document.getElementById('changedRecordCount');
                if (countElement) countElement.textContent = changedRecordIds.size;
            }

            const resetBtn = document.getElementById('resetToDefaultBtn');
            if (resetBtn && tableBody) {
                resetBtn.addEventListener('click', function() {
                    const selectedCheckboxes = tableBody.querySelectorAll('tr input.row-checkbox:checked');
                    selectedCheckboxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        if (row && !row.classList.contains('row-locked')) {
                            const editableCells = row.querySelectorAll('td[contenteditable="true"]'); 
                            editableCells.forEach(cell => {
                                const initialVal = cell.dataset.initialValue || '';
                                const columnName = cell.dataset.columnName;
                                if (columnName && (columnName.includes('hourly_wage_new') || columnName.includes('allowance_new') || (columnName.startsWith('additional_wage') && columnName.endsWith('_new')))) {
                                     cell.textContent = formatCurrencyOrHyphen(initialVal);
                                } else if (columnName === 'annual_bonus_months_new') {
                                     cell.textContent = formatMonthsOrHyphen(initialVal);
                                }
                                else if (columnName && (columnName.includes('contract_hours_day_new') || columnName.includes('contract_days_month_new'))){
                                     cell.textContent = (initialVal === '-' || initialVal === '0' && parseNumericValue(initialVal) === 0) ? initialVal : parseNumericValue(initialVal).toString();
                                } else {
                                     cell.textContent = initialVal;
                                }
                                cell.classList.remove('highlight-changed');
                            });
                            updateLaborCostColumns(row);
                        }
                    });
                    updateChangedRecordCount();
                });
            }

            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox && tableBody) {
                selectAllCheckbox.addEventListener('change', function() {
                    const rowCheckboxes = tableBody.querySelectorAll('input.row-checkbox');
                    rowCheckboxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        if (row && !row.classList.contains('row-locked')) {
                             checkbox.checked = selectAllCheckbox.checked;
                        } else if (row && row.classList.contains('row-locked')) {
                             checkbox.checked = false;
                        }
                    });
                });
            }

            if (notifySelectedBtn) {
                notifySelectedBtn.addEventListener('click', function() {
                    const selectedCheckboxes = tableBody.querySelectorAll('tr input.row-checkbox:checked');
                    const selectedEmployeeNames = [];
                    selectedCheckboxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        if (row) {
                            const employeeNameCell = row.querySelector('td[data-column-name="employee_name"]');
                            if (employeeNameCell) {
                                selectedEmployeeNames.push(employeeNameCell.textContent.trim());
                            }
                        }
                    });
                    const confirmationMessageArea = document.querySelector('.confirmation-area p');
                    const originalText = confirmationMessageArea ? confirmationMessageArea.textContent : "";

                    if (selectedEmployeeNames.length > 0) {
                        console.log(`以下の従業員に通知を送信します（仮）: ${selectedEmployeeNames.join(', ')}`);
                        if(confirmationMessageArea){
                            confirmationMessageArea.textContent = `${selectedEmployeeNames.join(', ')} さんに通知を送信しました。（仮）`;
                            setTimeout(() => { confirmationMessageArea.textContent = originalText; }, 5000);
                        }
                    } else {
                        console.log("通知を送信する従業員が選択されていません。");
                         if(confirmationMessageArea){
                            confirmationMessageArea.textContent = `通知対象が選択されていません。`;
                            setTimeout(() => { confirmationMessageArea.textContent = originalText; }, 3000);
                        }
                    }
                });
            }
            updateChangedRecordCount();
        });
    </script>
</body>
</html>
